{% set STATIC_VERSION = "20240610" %}
<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}B.O.M.{% endblock %}</title>

    <!-- CSS comuni -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/tabs.css?v={{ STATIC_VERSION }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css?v={{ STATIC_VERSION }}">
    <link rel="stylesheet" href="/static/css/crea_protocolli.css?v={{ STATIC_VERSION }}">

    <!-- JS tema -->
    <script>
        // Applica il tema salvato immediatamente per evitare FOUC (Flash of Unstyled Content)
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
    </script>
    <script src="/static/js/theme.js?v={{ STATIC_VERSION }}"></script>
    {% block head_extra %}{% endblock %}
</head>

<body>
    <script>
        try {
            if (localStorage.getItem('sidebarCollapsed') === 'true' && window.innerWidth > 992) {
                document.body.classList.add('sidebar-collapsed');
            }
        } catch (e) { }
    </script>
    <div class="sidebar-trigger-area"></div>
    <!-- Navbar -->
    <nav class="navbar fixed-top">
        <div class="container-fluid">
            <div class="navbar-brand">
                <img src="/static/img/bei-logo.png" alt="BEI Logo">
                <h1 class="brand-text">B.O.M.</h1>
                {% if app_mode and app_mode != "REMOTO" %}
                <span class="badge bg-warning text-dark ms-3" style="font-size:1rem; vertical-align:middle;">
                    Connessione: {{ app_mode }}
                </span>
                {% endif %}
            </div>
            <div class="top-nav">
                <a href="#" class="nav-link">
                    <i class="fas fa-bell"></i>
                </a>
                {% if username %}
                <div class="dropdown">
                    <button class="btn btn-sm dropdown-toggle d-flex align-items-center"
                        style="background: transparent; color: var(--text);" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-1"></i>
                        <span style="font-size: 0.9rem;">{{ username }}</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item text-danger px-3 py-2" href="/logout" style="font-size: 0.85rem;">
                                <i class="fas fa-sign-out-alt me-2"></i> Esci
                            </a>
                        </li>
                    </ul>
                </div>
                {% endif %}

            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar-overlay"></div>
        <aside class="sidebar">
            <div class="sidebar-pin-toggle" title="Nascondi/Mostra menu">
                <i class="fas fa-thumbtack"></i>
            </div>
            <div class="menu-section">
                <div class="menu-header">Menu Principale</div>
                <a href="/" class="menu-item {% if request.path == '/' %}active{% endif %}">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="/ordini_materiale" id="ordini-materiale-menu"
                    class="menu-item {% if request.path.startswith('/ordini_materiale') %}active{% endif %}">
                    <i class="fas fa-box"></i>Ordini Materiale
                </a>
                <a href="/ordini_servizi"
                    class="menu-item {% if request.path.startswith('/ordini_servizi') %}active{% endif %}">
                    <i class="fas fa-file-invoice"></i>Ordini Servizi
                </a>
                <a href="/protocolli"
                    class="menu-item {% if request.path.startswith('/protocolli') %}active{% endif %}">
                    <i class="fas fa-folder-open"></i> Protocolli
                </a>
            </div>
            <div class="menu-section">
                <div class="menu-header">Gestione</div>
                <a href="/impostazioni" class="menu-item {% if request.path == '/impostazioni' %}active{% endif %}">
                    <i class="fas fa-cog"></i> Impostazioni
                </a>
                <a href="#" class="menu-item">
                    <i class="fas fa-user-cog"></i> Profilo
                </a>
            </div>
        </aside>

        <!-- Contenuto principale -->
        <main id="main-content" class="main-content">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- JavaScript comuni -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="/static/js/main.js?v={{ STATIC_VERSION }}"></script>

    <!-- DataTables CSS -->
    <link rel="stylesheet"
        href="https://cdn.datatables.net/v/bs5/dt-1.13.8/b-2.4.2/b-colvis-2.4.2/b-html5-2.4.2/b-print-2.4.2/r-2.5.0/sl-1.7.0/datatables.min.css" />
    <!-- ColReorder CSS -->
    <!-- <link rel="stylesheet" href="https://cdn.datatables.net/colreorder/1.6.2/css/colReorder.dataTables.min.css" /> -->

    <!-- DataTables JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script
        src="https://cdn.datatables.net/v/bs5/dt-1.13.8/b-2.4.2/b-colvis-2.4.2/b-html5-2.4.2/b-print-2.4.2/r-2.5.0/sl-1.7.0/datatables.min.js"></script>
    <!-- ColReorder JS -->
    <!-- <script src="https://cdn.datatables.net/colreorder/1.6.2/js/dataTables.colReorder.min.js"></script> -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (async function () {
            if (document.cookie.includes('session=')) {
                try {
                    const res = await fetch('/impostazioni/api/tema');
                    const data = await res.json();
                    const tema = data.tema || 'light';
                    document.documentElement.setAttribute('data-theme', tema);
                    localStorage.setItem('theme', tema);
                } catch (e) {
                    document.documentElement.setAttribute('data-theme', 'light');
                }
            }
        })();
    </script>
    {% block script_extra %}{% endblock %}
</body>

</html>